<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Event - College Event Website</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>College Event Website</h1>
    <nav>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="events.html">Events</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="login.html">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>Create New Event</h2>
    <form id="create-event-form">
      <label for="event-name">Event Name:</label>
      <input type="text" id="event-name" name="event_name" required />

      <label for="event-category">Category:</label>
      <input type="text" id="event-category" name="event_category" required />

      <label for="event-description">Description:</label>
      <textarea id="event-description" name="description" required></textarea>

      <label for="event-date">Date:</label>
      <input type="date" id="event-date" name="event_date" required />

      <label for="event-time">Time:</label>
      <input type="time" id="event-time" name="event_time" required />

      <label for="location">Location:</label>
      <input type="text" id="location" name="location" required />
      <button id="selectLocationBtn" type="button" onclick="openMapPopup()">Choose on Map</button>

      <label for="contact-phone">Contact Phone:</label>
      <input type="text" id="contact-phone" name="contact_phone" />

      <label for="contact-email">Contact Email:</label>
      <input type="email" id="contact-email" name="contact_email" />

      <input type="hidden" id="ISA_type" name="ISA_type" value="Public" />
      <input type="hidden" id="university_ID" name="university_ID" />
      <input type="hidden" id="created_by_UID" name="created_by_UID" />

      <button type="submit">Create Event</button>
    </form>
    <div id="create-event-result"></div>
  </main>

  <footer>
    <p>&copy; 2025 College Event Website</p>
  </footer>

  <script>
    function openMapPopup() {
      window.open('map-popup.html', 'MapPopup', 'width=700,height=600');
    }
  
    // Receive address from map popup
    window.addEventListener('message', function(event) {
      if (typeof event.data === 'string') {
        document.getElementById('location').value = event.data;
      }
    }, false);
  
    // Role check
    const userRole = localStorage.getItem("userRole");
    if (!(userRole === "admin" || userRole === "superadmin")) {
      alert("Unauthorized. Only admin users can create events.");
      window.location.href = "dashboard.html";
    }
  
    // Populate user data
    const userDataStr = localStorage.getItem("user");
    if (userDataStr) {
      try {
        const userData = JSON.parse(userDataStr);
        document.getElementById("university_ID").value = userData.university_ID || "";
        document.getElementById("created_by_UID").value = userData.id || "";
      } catch (e) {
        console.error("Error parsing user data:", e);
      }
    }
  
    // Handle form submission
    document.getElementById("create-event-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const resultDiv = document.getElementById("create-event-result");
      resultDiv.innerHTML = "⏳ Creating location...";
  
      const address = document.getElementById("location").value.trim();
  
      try {
        // Step 1: Create the location
        const locRes = await fetch("api/createLocation.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address })
        });
  
        const locData = await locRes.json();
  
        if (!locData.success) {
          resultDiv.innerHTML = `<p>❌ Error creating location: ${locData.error}</p>`;
          return;
        }
  
        const location_ID = locData.location.location_ID;
  
        // Step 2: Submit the event with location_ID
        const eventData = {
          event_name: document.getElementById("event-name").value,
          event_category: document.getElementById("event-category").value,
          description: document.getElementById("event-description").value,
          event_date: document.getElementById("event-date").value,
          event_time: document.getElementById("event-time").value,
          location_ID: location_ID,
          contact_phone: document.getElementById("contact-phone").value,
          contact_email: document.getElementById("contact-email").value,
          ISA_type: document.getElementById("ISA_type").value,
          university_ID: parseInt(document.getElementById("university_ID").value),
          created_by_UID: parseInt(document.getElementById("created_by_UID").value)
        };
  
        const eventRes = await fetch("api/createEvent.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(eventData)
        });
  
        const eventResult = await eventRes.json();
  
        if (eventResult.success) {
          resultDiv.innerHTML = "<p>✅ Event created successfully!</p>";
          document.getElementById("create-event-form").reset();
        } else {
          resultDiv.innerHTML = `<p>❌ Error creating event: ${eventResult.error}</p>`;
        }
      } catch (err) {
        console.error("Error creating event:", err);
        resultDiv.innerHTML = "<p>❌ An unexpected error occurred. Please try again.</p>";
      }
    });
  </script>
  
</body>
</html>
